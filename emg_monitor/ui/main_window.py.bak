"""Qt main window for the EMG monitor application."""

from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, Optional

import numpy as np
import pyqtgraph as pg
from PyQt6 import QtCore, QtWidgets
from qasync import asyncSlot

# macOS å„ªåŒ–è¨­å®šï¼šä½¿ç”¨åŸç”ŸåŠ é€Ÿï¼Œé—œé–‰å¯èƒ½ä¸ç©©å®šçš„åŠŸèƒ½
pg.setConfigOptions(
    useOpenGL=True,  # åœ¨ macOS ä¸Šæœƒè‡ªå‹•ä½¿ç”¨ Metal å…¼å®¹å±¤
    antialias=False,  # é—œé–‰æŠ—é‹¸é½’ä»¥æå‡æ•ˆèƒ½
    enableExperimental=False,  # é—œé–‰å¯¦é©—æ€§åŠŸèƒ½
)

from .. import config
from ..buffers import EmgRingBuffer
from ..data_parser import EmgSample, ImuSample
from ..device_manager import DeviceManager
from ..sim_device import SimulatedDeviceManager
from ..serial_device import SerialDeviceManager


class PacketBridge(QtCore.QObject):
    """Bridge raw callbacks to Qt signals."""

    emg_received = QtCore.pyqtSignal(object)
    imu_received = QtCore.pyqtSignal(object)
    status_changed = QtCore.pyqtSignal(str)

    def emit_packet(self, packet: EmgSample | ImuSample) -> None:
        if isinstance(packet, EmgSample):
            self.emg_received.emit(packet)
        else:
            self.imu_received.emit(packet)

    def emit_status(self, message: str) -> None:
        self.status_changed.emit(message)


@dataclass
class DeviceEntry:
    label: str
    address: str


class MainWindow(QtWidgets.QMainWindow):
    """Top-level application window."""

    def __init__(self) -> None:
        super().__init__()
        self.setWindowTitle("WL-EMG Monitor")
        self._bridge = PacketBridge()
        self._bridge.emg_received.connect(self._handle_emg_sample)
        self._bridge.imu_received.connect(self._handle_imu_sample)
        self._bridge.status_changed.connect(self._handle_status_update)

        self._real_manager = DeviceManager(
            notification_uuid=config.DEFAULT_NOTIFICATION_UUID,
            on_packet=self._bridge.emit_packet,
            on_status=self._bridge.emit_status,
        )
        self._serial_manager = SerialDeviceManager(
            on_packet=self._bridge.emit_packet,
            on_status=self._bridge.emit_status,
        )
        self._sim_manager = SimulatedDeviceManager(
            on_packet=self._bridge.emit_packet,
            on_status=self._bridge.emit_status,
        )
        self._active_manager: Optional[
            DeviceManager | SerialDeviceManager | SimulatedDeviceManager
        ] = None

        self._device_items: Dict[int, DeviceEntry] = {}
        self._connected = False
        self._buffer = EmgRingBuffer(
            channels=config.EMG_CHANNELS,
            capacity=config.SAMPLE_RATE_HZ * config.BUFFER_SECONDS,
        )
        self._display_offsets = [
            idx * 400.0 for idx in range(config.EMG_CHANNELS)
        ]
        
        # ç‹€æ…‹è¿½è¹¤
        self._last_packet_time = 0.0
        self._packet_count = 0
        self._signal_strength = 0.0
        self._is_simulation = False
        
        # é€šé“åŸºç·šè¿½è¹¤ï¼ˆç”¨æ–¼è¨ˆç®—è®ŠåŒ–é‡ï¼‰
        self._channel_baseline = [0.0] * config.EMG_CHANNELS
        self._channel_last_values = [0.0] * config.EMG_CHANNELS
        self._channel_current_state = [0] * config.EMG_CHANNELS  # ç•¶å‰ç‹€æ…‹ï¼ˆ0=å¾…æ©Ÿ, 1=æ­£å¸¸, 2=è‰¯å¥½, 3=å¼·è¨Šè™Ÿï¼‰
        self._channel_noise_level = [0.0] * config.EMG_CHANNELS  # æ¯å€‹é€šé“çš„åŸºç·šå™ªéŸ³æ°´å¹³
        self._baseline_initialized = False  # åŸºç·šæ˜¯å¦å·²åˆå§‹åŒ–
        self._initialization_samples = 500  # åˆå§‹åŒ–éœ€è¦çš„æ¨£æœ¬æ•¸ï¼ˆç´„2.5ç§’ï¼‰
        self._last_baseline_reset = 0  # ä¸Šæ¬¡åŸºç·šé‡ç½®æ™‚é–“

        self._build_ui()
        self._plot_timer = QtCore.QTimer(self)
        self._plot_timer.setInterval(100)  # é™ä½åˆ° 10 FPSï¼Œæ¸›å°‘ CPU è² è¼‰
        self._plot_timer.timeout.connect(self._refresh_plot)
        self._plot_timer.start()

        self._log("Ready.")
        
        # å•Ÿå‹•æ™‚è‡ªå‹•æƒæåºåˆ—åŸ 
        QtCore.QTimer.singleShot(500, self._on_usb_scan_clicked)

    # ------------------------------------------------------------------ UI --
    def _build_ui(self) -> None:
        central = QtWidgets.QWidget(self)
        layout = QtWidgets.QVBoxLayout(central)
        
        # æ§åˆ¶æŒ‰éˆ•ï¼šåºåˆ—åŸ æª¢æ¸¬èˆ‡é€£æ¥
        controls_layout = QtWidgets.QHBoxLayout()
        
        self._usb_scan_button = QtWidgets.QPushButton("ğŸ” Scan Serial Ports")
        self._usb_scan_button.clicked.connect(self._on_usb_scan_clicked)
        self._usb_scan_button.setStyleSheet("font-weight: bold; background-color: #4CD964; color: white;")
        controls_layout.addWidget(self._usb_scan_button)
        
        # åºåˆ—åŸ åˆ—è¡¨ä¸‹æ‹‰é¸å–®
        self._usb_device_combo = QtWidgets.QComboBox()
        self._usb_device_combo.setMinimumWidth(400)
        self._usb_device_combo.addItem("æ­£åœ¨æƒæ...")
        controls_layout.addWidget(self._usb_device_combo, stretch=1)

        self._connect_button = QtWidgets.QPushButton("Connect")
        self._connect_button.clicked.connect(self._on_connect_clicked)
        controls_layout.addWidget(self._connect_button)

        self._disconnect_button = QtWidgets.QPushButton("Disconnect")
        self._disconnect_button.clicked.connect(self._on_disconnect_clicked)
        self._disconnect_button.setEnabled(False)
        controls_layout.addWidget(self._disconnect_button)
        
        controls_layout.addStretch()
        layout.addLayout(controls_layout)

        # ç‹€æ…‹æŒ‡ç¤ºå™¨å€åŸŸ
        status_group = QtWidgets.QGroupBox("ç³»çµ±ç‹€æ…‹")
        status_layout = QtWidgets.QHBoxLayout()
        
        # 1. USB æ¥æ”¶å™¨ç‹€æ…‹ï¼ˆæ–°å¢ï¼‰
        self._usb_status_label = QtWidgets.QLabel("ğŸ”Œ USB æ¥æ”¶å™¨")
        self._usb_status_indicator = QtWidgets.QLabel("â—")
        self._usb_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._usb_status_text = QtWidgets.QLabel("æœªæª¢æ¸¬")
        self._usb_status_text.setStyleSheet("color: gray;")
        status_layout.addWidget(self._usb_status_label)
        status_layout.addWidget(self._usb_status_indicator)
        status_layout.addWidget(self._usb_status_text)
        status_layout.addSpacing(20)
        
        # è¨Šè™Ÿæ¥æ”¶ç‹€æ…‹
        self._signal_status_label = QtWidgets.QLabel("ğŸ“¶ è¨Šè™Ÿæ¥æ”¶")
        self._signal_status_indicator = QtWidgets.QLabel("â—")
        self._signal_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        status_layout.addWidget(self._signal_status_label)
        status_layout.addWidget(self._signal_status_indicator)
        status_layout.addSpacing(20)
        
        # è¨Šè™Ÿå¼·åº¦
        self._strength_label = QtWidgets.QLabel("ğŸ’ª è¨Šè™Ÿå¼·åº¦: --")
        status_layout.addWidget(self._strength_label)
        status_layout.addStretch()
        
        status_group.setLayout(status_layout)
        layout.addWidget(status_group)

        # 8 é€šé“è¨Šè™Ÿç›£æ§é¢æ¿
        channels_group = QtWidgets.QGroupBox("8 é€šé“è¨Šè™Ÿç›£æ§")
        channels_layout = QtWidgets.QHBoxLayout()
        
        self._channel_indicators = []
        self._channel_strength_labels = []
        self._channel_quality_labels = []
        
        colors = ["#FF3B30", "#FF9500", "#FFCC00", "#4CD964", "#5AC8FA", "#007AFF", "#5856D6", "#FF2D55"]
        
        for i in range(config.EMG_CHANNELS):
            # æ¯å€‹é€šé“çš„å‚ç›´ä½ˆå±€
            ch_layout = QtWidgets.QVBoxLayout()
            
            # é€šé“æ¨™ç±¤
            ch_label = QtWidgets.QLabel(f"CH{i+1}")
            ch_label.setStyleSheet(f"font-weight: bold; color: {colors[i]}; font-size: 12px;")
            ch_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
            ch_layout.addWidget(ch_label)
            
            # è¨Šè™Ÿå¼·åº¦æŒ‡ç¤ºå™¨ï¼ˆåœ“é»ï¼‰
            indicator = QtWidgets.QLabel("â—")
            indicator.setStyleSheet("color: gray; font-size: 24px;")
            indicator.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
            self._channel_indicators.append(indicator)
            ch_layout.addWidget(indicator)
            
            # è¨Šè™Ÿå¼·åº¦æ•¸å€¼
            strength_label = QtWidgets.QLabel("--")
            strength_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
            strength_label.setStyleSheet("font-size: 10px; color: #888;")
            self._channel_strength_labels.append(strength_label)
            ch_layout.addWidget(strength_label)
            
            # è¨Šè™Ÿå“è³ª
            quality_label = QtWidgets.QLabel("--")
            quality_label.setAlignment(QtCore.Qt.AlignmentFlag.AlignCenter)
            quality_label.setStyleSheet("font-size: 9px; color: #666;")
            self._channel_quality_labels.append(quality_label)
            ch_layout.addWidget(quality_label)
            
            channels_layout.addLayout(ch_layout)
        
        channels_group.setLayout(channels_layout)
        layout.addWidget(channels_group)

        self._status_label = QtWidgets.QLabel("Status: Disconnected")
        layout.addWidget(self._status_label)

        # 8 å€‹ç¨ç«‹ç¹ªåœ–è¦–çª—ï¼ˆ2x4 æ ¼å±€ï¼‰
        plots_group = QtWidgets.QGroupBox("8 é€šé“å³æ™‚æ³¢å½¢")
        plots_grid = QtWidgets.QGridLayout()
        plots_grid.setSpacing(5)
        
        colors = [
            "#FF3B30",  # CH1 ç´…è‰²
            "#FF9500",  # CH2 æ©™è‰²
            "#FFCC00",  # CH3 é»ƒè‰²
            "#4CD964",  # CH4 ç¶ è‰²
            "#5AC8FA",  # CH5 æ·ºè—è‰²
            "#007AFF",  # CH6 è—è‰²
            "#5856D6",  # CH7 ç´«è‰²
            "#FF2D55",  # CH8 ç²‰ç´…è‰²
        ]
        
        self._plot_widgets = []
        self._curves = []
        
        for idx in range(config.EMG_CHANNELS):
            # å‰µå»ºæ¯å€‹é€šé“çš„ç¹ªåœ–è¦–çª—
            plot_widget = pg.PlotWidget()
            plot_widget.setBackground("k")
            plot_widget.showGrid(x=True, y=True, alpha=0.2)
            plot_widget.setLabel("left", "Deviation (Î¼V)", **{"font-size": "10pt"})
            plot_widget.setLabel("bottom", "Time (s)", **{"font-size": "10pt"})
            plot_widget.setTitle(f"CH{idx+1}", color=colors[idx], size="12pt")
            plot_widget.setLimits(xMin=-config.BUFFER_SECONDS, xMax=0)
            plot_widget.setYRange(-5000, 5000)  # é è¨­ç¯„åœ
            plot_widget.setMouseEnabled(x=False, y=True)  # åªå…è¨± Y è»¸ç¸®æ”¾
            
            # å‰µå»ºæ›²ç·š
            curve = plot_widget.plot(
                pen=pg.mkPen(color=colors[idx], width=2)
            )
            
            self._plot_widgets.append(plot_widget)
            self._curves.append(curve)
            
            # æ’åˆ—æˆ 2 è¡Œ 4 åˆ—
            row = idx // 4
            col = idx % 4
            plots_grid.addWidget(plot_widget, row, col)
        
        plots_group.setLayout(plots_grid)
        layout.addWidget(plots_group, stretch=1)

        self._log_view = QtWidgets.QPlainTextEdit()
        self._log_view.setReadOnly(True)
        self._log_view.setMaximumHeight(80)
        layout.addWidget(self._log_view)

        central.setLayout(layout)
        self.setCentralWidget(central)
        self.resize(1400, 900)

    # -------------------------------------------------------------- Helpers --
    def _current_device(self) -> DeviceEntry:
        idx = self._device_combo.currentIndex()
        entry = self._device_items.get(idx)
        if entry is None:
            raise ValueError("No device selected")
        return entry

    def _set_controls_enabled(self, scanning: bool = False) -> None:
        self._connect_button.setEnabled(not self._connected and not scanning)
        self._disconnect_button.setEnabled(self._connected)
        self._usb_scan_button.setEnabled(not scanning)
        self._usb_device_combo.setEnabled(not self._connected and not scanning)

    def _log(self, message: str) -> None:
        self._log_view.appendPlainText(message)

    # ------------------------------------------------------------ Callbacks --
    def _handle_emg_sample(self, sample: EmgSample) -> None:
        try:
            self._buffer.append(sample.channels_uv)
            # æ›´æ–°è¨Šè™Ÿæ¥æ”¶ç‹€æ…‹
            import time
            self._last_packet_time = time.time()
            self._packet_count += 1
            
            # åˆå§‹åŒ–éšæ®µï¼šåªå»ºç«‹åŸºç·šï¼Œä¸é¡¯ç¤ºè¨Šè™Ÿå“è³ª
            if not self._baseline_initialized:
                if self._packet_count <= self._initialization_samples:
                    # å¿«é€Ÿå»ºç«‹åŸºç·šä¸¦ç´¯ç©æ´»å‹•åº¦ï¼ˆç”¨æ–¼è¨ˆç®—å™ªéŸ³æ°´å¹³ï¼‰
                    for i, ch_value in enumerate(sample.channels_uv):
                        alpha = 0.1  # åˆå§‹åŒ–æ™‚ä½¿ç”¨è¼ƒå¿«çš„æ›´æ–°é€Ÿåº¦
                        self._channel_baseline[i] = alpha * ch_value + (1 - alpha) * self._channel_baseline[i]
                        
                        # è¨ˆç®—ç•¶å‰æ´»å‹•åº¦ä¸¦ç´¯ç©ï¼ˆç”¨æ–¼è¨ˆç®—å¹³å‡å™ªéŸ³æ°´å¹³ï¼‰
                        if self._packet_count > 50:  # å‰50å€‹å°åŒ…è®“åŸºç·šç©©å®š
                            deviation = abs(ch_value - self._channel_baseline[i])
                            change_rate = abs(ch_value - self._channel_last_values[i])
                            activity = (deviation * 0.7 + change_rate * 0.3)
                            # ç´¯ç©å¹³å‡å™ªéŸ³æ°´å¹³
                            self._channel_noise_level[i] += activity
                        
                        self._channel_last_values[i] = ch_value
                    
                    # é¡¯ç¤ºåˆå§‹åŒ–é€²åº¦ï¼ˆé™ä½é »ç‡ï¼‰
                    if self._packet_count % 100 == 0:
                        progress = (self._packet_count / self._initialization_samples) * 100
                        print(f"åŸºç·šåˆå§‹åŒ–ä¸­... {progress:.0f}%")
                    
                    # æ‰€æœ‰é€šé“é¡¯ç¤ºç‚ºç°è‰²ã€Œæ ¡æº–ä¸­ã€
                    for i in range(8):
                        if i < len(self._channel_indicators):
                            self._channel_indicators[i].setStyleSheet("color: gray; font-size: 24px;")
                            self._channel_quality_labels[i].setText("æ ¡æº–ä¸­")
                            self._channel_quality_labels[i].setStyleSheet("font-size: 9px; color: #888;")
                            self._channel_strength_labels[i].setText("--")
                    
                    return  # åˆå§‹åŒ–æœŸé–“ä¸é€²è¡Œè¨Šè™Ÿå“è³ªåˆ¤æ–·
                else:
                    # åˆå§‹åŒ–å®Œæˆï¼šè¨ˆç®—æ¯å€‹é€šé“çš„å¹³å‡å™ªéŸ³æ°´å¹³
                    self._baseline_initialized = True
                    for i in range(config.EMG_CHANNELS):
                        # è¨ˆç®—å¹³å‡å™ªéŸ³ï¼ˆé™¤ä»¥æœ‰æ•ˆæ¨£æœ¬æ•¸ï¼‰
                        self._channel_noise_level[i] = self._channel_noise_level[i] / (self._initialization_samples - 50)
                    
                    print("åŸºç·šåˆå§‹åŒ–å®Œæˆï¼")
                    print(f"å„é€šé“åŸºç·š: {[f'{b:.0f}' for b in self._channel_baseline]}")
                    print(f"å„é€šé“å™ªéŸ³æ°´å¹³: {[f'{n:.0f}' for n in self._channel_noise_level]}")
                    self._last_baseline_reset = self._packet_count
            
            # å®šæœŸé‡æ–°æ ¡æº–åŸºç·šï¼ˆæ¯ 30 ç§’ï¼Œç•¶æ‰€æœ‰é€šé“éƒ½åœ¨å¾…æ©Ÿç‹€æ…‹æ™‚ï¼‰
            if self._packet_count - self._last_baseline_reset > 6000:  # 30ç§’
                all_idle = all(state == 0 for state in self._channel_current_state)
                if all_idle:
                    print("\nâŸ³ åŸºç·šè‡ªå‹•é‡æ–°æ ¡æº–...")
                    self._baseline_initialized = False
                    self._packet_count = 0
                    return
            
            # æ­£å¸¸é‹ä½œï¼šè¨ˆç®—æ¯å€‹é€šé“çš„è¨Šè™Ÿæ´»å‹•åº¦ï¼ˆè®ŠåŒ–é‡ï¼‰
            channel_activity = []
            for i, ch_value in enumerate(sample.channels_uv):
                # è¨ˆç®—ç•¶å‰åé›¢å€¼
                deviation = abs(ch_value - self._channel_baseline[i])
                
                # æ”¹é€²åŸºç·šæ›´æ–°ç­–ç•¥ï¼šä½¿ç”¨è‡ªé©æ‡‰é€Ÿç‡
                if deviation < self._channel_noise_level[i] * 2:
                    # è¨Šè™Ÿæ¥è¿‘åŸºç·šï¼Œå¿«é€Ÿæ›´æ–°
                    alpha = 0.02
                elif deviation < self._channel_noise_level[i] * 5:
                    # ä¸­ç­‰è¨Šè™Ÿï¼Œæ…¢é€Ÿæ›´æ–°
                    alpha = 0.002
                else:
                    # å¼·è¨Šè™Ÿï¼Œæ¥µæ…¢æ›´æ–°ï¼ˆä½†ä¸å®Œå…¨åœæ­¢ï¼‰
                    alpha = 0.0001
                
                self._channel_baseline[i] = alpha * ch_value + (1 - alpha) * self._channel_baseline[i]
                
                # æ´»å‹•åº¦åªçœ‹åé›¢å€¼
                activity = deviation
                channel_activity.append(activity)
                
                # æ›´æ–°ä¸Šæ¬¡æ•¸å€¼
                self._channel_last_values[i] = ch_value
            
            # æ‰¹æ¬¡æ›´æ–°é€šé“æŒ‡ç¤ºå™¨ï¼ˆæ¯ 5 å€‹å°åŒ…æ›´æ–°ä¸€æ¬¡ï¼Œæ¸›å°‘ UI åˆ·æ–°ï¼‰
            if self._packet_count % 5 == 0:
                for i, activity in enumerate(channel_activity):
                    self._update_channel_indicator(i, activity)
            
            # å³æ™‚ç›£æ¸¬ï¼šæ¯ 50 å€‹å°åŒ…è¼¸å‡ºä¸€æ¬¡ï¼ˆç´„ 250ms é–“éš”ï¼Œé€²ä¸€æ­¥é™ä½è² è¼‰ï¼‰
            # å¦‚æœä¸éœ€è¦çµ‚ç«¯æ©Ÿç›£æ¸¬ï¼Œå¯ä»¥è¨»è§£æ‰ä»¥ä¸‹æ•´å€‹ if å€å¡Š
            if self._packet_count % 50 == 0:
                # é¡¯ç¤ºæ¯å€‹é€šé“çš„æ´»å‹•åº¦å’Œç‹€æ…‹
                status_map = {0: "å¾…æ©Ÿ", 1: "æ­£å¸¸", 2: "è‰¯å¥½", 3: "å¼·è¨Šè™Ÿ"}
                ch_info = []
                active_channels = []  # è¨˜éŒ„æ´»èºçš„é€šé“
                
                for i in range(len(channel_activity)):
                    state_text = status_map.get(self._channel_current_state[i], "?")
                    # æ¨™è¨˜æ´»èºçš„é€šé“ï¼ˆæ´»å‹•åº¦ > é–¾å€¼ï¼‰
                    threshold = self._channel_noise_level[i] * 2.5
                    if channel_activity[i] > threshold:
                        ch_info.append(f"CH{i+1}:ã€{channel_activity[i]:.0f}ã€‘{state_text}")
                        active_channels.append(i+1)
                    else:
                        ch_info.append(f"CH{i+1}:{channel_activity[i]:.0f}")
                
                # é¡¯ç¤ºæ´»èºé€šé“æ•¸ï¼ˆç”¨æ–¼è¨ºæ–·ä¸²æ“¾ï¼‰
                active_count = len(active_channels)
                if active_count > 1:
                    isolation_warning = f" âš ï¸ {active_count}å€‹é€šé“æ´»èº:{active_channels}"
                else:
                    isolation_warning = ""
                
                # æ¸…é™¤èˆŠè¡Œä¸¦é¡¯ç¤ºæ–°ç‹€æ…‹ï¼ˆä½¿ç”¨ \r å›åˆ°è¡Œé¦–ï¼‰
                print(f"\rå°åŒ…#{self._packet_count:5d} | " + " | ".join(ch_info) + isolation_warning, end="", flush=True)
            
            # è¨ˆç®—æ•´é«”è¨Šè™Ÿå¼·åº¦
            self._signal_strength = np.mean(channel_activity)
            
            # æ›´æ–°è¨Šè™Ÿæ¥æ”¶æŒ‡ç¤ºå™¨ç‚ºç¶ è‰²
            self._signal_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
            
        except ValueError as exc:
            self._log(f"EMG buffer error: {exc}")
    
    def _update_channel_indicator(self, channel_idx: int, strength: float) -> None:
        """æ›´æ–°å–®å€‹é€šé“çš„è¨Šè™ŸæŒ‡ç¤ºå™¨ï¼ˆå¸¶é²æ»¯æ©Ÿåˆ¶é¿å…è·³å‹•ï¼‰"""
        if channel_idx >= len(self._channel_indicators):
            return
        
        indicator = self._channel_indicators[channel_idx]
        strength_label = self._channel_strength_labels[channel_idx]
        quality_label = self._channel_quality_labels[channel_idx]
        
        # æ›´æ–°å¼·åº¦æ•¸å€¼ï¼ˆé¡¯ç¤ºæ´»å‹•åº¦ï¼‰
        strength_label.setText(f"{strength:.0f}")
        
        # å–å¾—ç•¶å‰ç‹€æ…‹
        current_state = self._channel_current_state[channel_idx]
        
        # æ ¹æ“šè©²é€šé“çš„å™ªéŸ³æ°´å¹³å‹•æ…‹è¨­å®šé–¾å€¼ï¼ˆå€ç‡æ³•ï¼‰
        # åŸºç·šå™ªéŸ³çš„ 2.5 å€è¦–ç‚ºã€Œæ­£å¸¸ã€è¨Šè™Ÿï¼Œ4 å€ç‚ºã€Œè‰¯å¥½ã€ï¼Œ6 å€ç‚ºã€Œå¼·è¨Šè™Ÿã€
        noise_baseline = max(self._channel_noise_level[channel_idx], 100)  # è‡³å°‘100 Î¼V
        
        # ä½¿ç”¨é²æ»¯é–¾å€¼ï¼šä¸Šå‡é–¾å€¼è¼ƒé«˜ï¼Œä¸‹é™é–¾å€¼è¼ƒä½ï¼ˆé¿å…åè¦†è·³å‹•ï¼‰
        # å®šç¾©é–¾å€¼ï¼š[ä¸‹é™é–¾å€¼, ä¸Šå‡é–¾å€¼]
        thresholds = {
            0: (0, noise_baseline * 2.5),           # å¾…æ©Ÿ -> æ­£å¸¸ï¼šéœ€è¦ > 2.5å€å™ªéŸ³
            1: (noise_baseline * 2.0, noise_baseline * 4.0),  # æ­£å¸¸ <-> è‰¯å¥½
            2: (noise_baseline * 3.5, noise_baseline * 6.0), # è‰¯å¥½ <-> å¼·è¨Šè™Ÿ
            3: (noise_baseline * 5.5, 999999)       # å¼·è¨Šè™Ÿ
        }
        
        # æ±ºå®šæ–°ç‹€æ…‹ï¼ˆå…è¨±è·¨ç´šä¸‹é™ï¼‰
        new_state = current_state
        
        # å…ˆåˆ¤æ–·ä¸‹é™ï¼ˆå¯ä»¥è·¨ç´šï¼‰
        if strength < thresholds[0][1]:
            # ä½æ–¼æ­£å¸¸é–¾å€¼ï¼Œå›åˆ°å¾…æ©Ÿ
            new_state = 0
        elif strength < thresholds[1][1]:
            # ä½æ–¼è‰¯å¥½é–¾å€¼ï¼Œä½†é«˜æ–¼æ­£å¸¸é–¾å€¼
            if current_state >= 2:
                new_state = 1  # å¾è‰¯å¥½/å¼·è¨Šè™Ÿé™åˆ°æ­£å¸¸
        elif strength < thresholds[2][1]:
            # ä½æ–¼å¼·è¨Šè™Ÿé–¾å€¼
            if current_state >= 3:
                new_state = 2  # å¾å¼·è¨Šè™Ÿé™åˆ°è‰¯å¥½
        
        # å†åˆ¤æ–·ä¸Šå‡ï¼ˆéœ€è¦é²æ»¯ï¼‰
        if current_state == 0 and strength >= thresholds[0][1]:
            new_state = 1
        elif current_state == 1 and strength >= thresholds[1][1]:
            new_state = 2
        elif current_state == 2 and strength >= thresholds[2][1]:
            new_state = 3
        
        # æ›´æ–°ç‹€æ…‹
        self._channel_current_state[channel_idx] = new_state
        
        # æ ¹æ“šæ–°ç‹€æ…‹è¨­å®šé¡¯ç¤º
        if new_state == 0:
            # å¾…æ©Ÿï¼šç°è‰²
            indicator.setStyleSheet("color: gray; font-size: 24px;")
            quality_label.setText("å¾…æ©Ÿ")
            quality_label.setStyleSheet("font-size: 9px; color: #888;")
        elif new_state == 1:
            # æ­£å¸¸ï¼šé»ƒè‰²
            indicator.setStyleSheet("color: #FFCC00; font-size: 24px;")
            quality_label.setText("æ­£å¸¸")
            quality_label.setStyleSheet("font-size: 9px; color: #FFCC00;")
        elif new_state == 2:
            # è‰¯å¥½ï¼šç¶ è‰²
            indicator.setStyleSheet("color: #4CD964; font-size: 24px;")
            quality_label.setText("è‰¯å¥½")
            quality_label.setStyleSheet("font-size: 9px; color: #4CD964; font-weight: bold;")
        else:
            # å¼·è¨Šè™Ÿï¼šç´…è‰²
            indicator.setStyleSheet("color: #FF3B30; font-size: 24px;")
            quality_label.setText("å¼·è¨Šè™Ÿ")
            quality_label.setStyleSheet("font-size: 9px; color: #FF3B30; font-weight: bold;")

    def _handle_imu_sample(self, sample: ImuSample) -> None:
        gyro = ", ".join(f"{axis:.2f}" for axis in sample.gyro_rads)
        accel = ", ".join(f"{axis:.2f}" for axis in sample.accel_mss)
        self._status_label.setText(
            f"Status: Connected | Gyro {gyro} rad/s | Accel {accel} m/s^2"
        )

    def _handle_status_update(self, message: str) -> None:
        self._log(message)
        prefix = "Status: Connected | " if self._connected else "Status: "
        self._status_label.setText(f"{prefix}{message}")

    def _refresh_plot(self) -> None:
        import time
        
        # åªåœ¨é€£æ¥æ™‚æ›´æ–°ç‹€æ…‹ï¼ˆæ¸›å°‘ä¸å¿…è¦çš„æ“ä½œï¼‰
        if not self._connected:
            return
        
        # æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        current_time = time.time()
        
        # æª¢æŸ¥è¨Šè™Ÿæ˜¯å¦é‚„åœ¨æ¥æ”¶ï¼ˆè¶…é1ç§’æ²’æ”¶åˆ°å°±é¡¯ç¤ºç´…è‰²ï¼‰
        if (current_time - self._last_packet_time) > 1.0:
            self._signal_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._strength_label.setText("ğŸ’ª è¨Šè™Ÿå¼·åº¦: ç„¡è¨Šè™Ÿ")
        else:
            # æ›´æ–°è¨Šè™Ÿå¼·åº¦é¡¯ç¤ºï¼ˆç°¡åŒ–ï¼‰
            if self._signal_strength > 100:
                strength_text = "å¼·ğŸŸ¢"
            elif self._signal_strength > 30:
                strength_text = "ä¸­ğŸŸ¡"
            else:
                strength_text = "å¼±ğŸŸ "
            self._strength_label.setText(f"ğŸ’ª {self._signal_strength:.0f}Î¼V {strength_text}")
        
        # ç¹ªåœ–ï¼šé¡¯ç¤ºåå·®å€¼ï¼ˆdeviationï¼‰ï¼Œå¾…æ©Ÿæ™‚ç‚ºå¹³ç·š
        data = self._buffer.snapshot()
        if data.size == 0:
            return
        
        points = data.shape[1]
        duration = points / config.SAMPLE_RATE_HZ
        x = np.linspace(-duration, 0, points)
        
        # æ›´æ–°æ¯å€‹é€šé“çš„ç¨ç«‹è¦–çª—
        for idx, curve in enumerate(self._curves):
            # è¨ˆç®—åå·®å€¼ï¼šåŸå§‹è¨Šè™Ÿ - åŸºç·š
            # é€™æ¨£å¾…æ©Ÿæ™‚æœƒæ˜¯æ¥è¿‘ 0 çš„å¹³ç·š
            if self._baseline_initialized:
                deviation = data[idx] - self._channel_baseline[idx]
            else:
                # åŸºç·šæœªåˆå§‹åŒ–æ™‚é¡¯ç¤ºåŸå§‹å€¼
                deviation = data[idx]
            
            curve.setData(x, deviation)

        # ---------------------------------------------------------- UI actions --
    @asyncSlot()
    async def _on_usb_scan_clicked(self) -> None:
        """æƒæåºåˆ—åŸ  (Serial Ports) - å°‹æ‰¾è—ç‰™æ¥æ”¶å™¨"""
        self._set_controls_enabled(scanning=True)
        self._log("ğŸ” æƒæåºåˆ—åŸ ...")
        
        # USB ç‹€æ…‹è¨­ç‚ºæª¢æ¸¬ä¸­ï¼ˆé»ƒè‰²ï¼‰
        self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
        
        # æ¸…ç©ºåˆ—è¡¨
        self._usb_device_combo.clear()
        
        try:
            # ä½¿ç”¨ SerialDeviceManager åˆ—å‡ºåºåˆ—åŸ 
            usb_serial_ports = SerialDeviceManager.list_ports()
            
            if usb_serial_ports:
                # æ‰¾åˆ° USB åºåˆ—åŸ 
                self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
                
                info = f"âœ“ æƒæå®Œæˆï¼šå…±æ‰¾åˆ° {len(usb_serial_ports)} å€‹ USB åºåˆ—åŸ "
                self._log(info)
                
                # å°‡åºåˆ—åŸ åŠ å…¥åˆ°ä¸‹æ‹‰é¸å–®
                for port in usb_serial_ports:
                    # æ¨™è¨˜å¯èƒ½æ˜¯è—ç‰™æ¥æ”¶å™¨çš„åŸ 
                    if 'usbserial' in port or 'usbmodem' in port:
                        label = f"ğŸ“¡ {port} (USB Serial)"
                    else:
                        label = f"{port} (USB Serial)"
                    
                    self._usb_device_combo.addItem(label, userData=port)
                
                # è¨˜éŒ„è©³ç´°åˆ—è¡¨
                self._log("\næƒæåˆ°çš„ USB åºåˆ—åŸ ï¼š")
                for i, port in enumerate(usb_serial_ports, 1):
                    self._log(f"  {i}. {port}")
                
            else:
                # æ²’æ‰¾åˆ° USB åºåˆ—åŸ 
                self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
                
                self._usb_device_combo.addItem("æœªæ‰¾åˆ° USB åºåˆ—åŸ ï¼ˆè«‹ç¢ºèªæ¥æ”¶å™¨å·²æ’å…¥ï¼‰")
                self._log("æœªæ‰¾åˆ° USB åºåˆ—åŸ ")
                    
        except Exception as exc:
            self._log(f"åºåˆ—åŸ æƒæå¤±æ•—: {exc}")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            self._usb_device_combo.addItem("æƒæå¤±æ•—")
            self._usb_info_label.setText("âœ— æƒæå¤±æ•—")
            self._usb_info_label.setStyleSheet("color: #FF3B30; font-style: italic;")
        finally:
            self._set_controls_enabled(scanning=False)

    @asyncSlot()
    async def _on_scan_clicked(self) -> None:
        """å·²æ£„ç”¨ï¼šè—ç‰™æƒæåŠŸèƒ½ï¼ˆç¾åœ¨åªä½¿ç”¨ USB åºåˆ—åŸ ï¼‰"""
        self._log("è—ç‰™æƒæåŠŸèƒ½å·²ç§»é™¤ï¼Œè«‹ä½¿ç”¨ USB åºåˆ—åŸ é€£æ¥")
        return
        
        # å˜—è©¦æƒææ™‚ï¼Œè—ç‰™æ¥æ”¶å™¨ç‹€æ…‹è¨­ç‚ºé»ƒè‰²ï¼ˆæª¢æ¸¬ä¸­ï¼‰
        self._bt_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
        
        self._device_combo.clear()
        self._device_combo.addItem("Simulation", userData="SIM")
        self._device_items = {0: DeviceEntry("Simulation", "SIM")}
        try:
            devices = await self._real_manager.scan(
                timeout=config.DEFAULT_SCAN_TIMEOUT
            )
            # æƒææˆåŠŸï¼Œè—ç‰™æ¥æ”¶å™¨è¨­ç‚ºç¶ è‰²
            self._bt_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
            
            # æª¢æŸ¥æ˜¯å¦æœ‰ WL è£ç½®ï¼ˆè¡¨ç¤º USB æ¥æ”¶å™¨å·²é€£æ¥ï¼‰
            has_wl_device = any("WL" in (dev.name or "").upper() or 
                               "EEG" in (dev.name or "").upper() 
                               for dev in devices)
            
            if has_wl_device:
                self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
                self._usb_status_text.setText("å·²åµæ¸¬åˆ° WL è£ç½®")
                self._usb_status_text.setStyleSheet("color: #4CD964; font-weight: bold;")
            else:
                self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
                self._usb_status_text.setText("æœªæ‰¾åˆ° WL è£ç½®")
                self._usb_status_text.setStyleSheet("color: #FFCC00;")
            
            # æŒ‰ RSSI æ’åºï¼ˆè¨Šè™Ÿå¼·åº¦ç”±å¼·åˆ°å¼±ï¼‰
            devices_sorted = sorted(devices, key=lambda d: d.rssi or -999, reverse=True)
            
            for dev in devices_sorted:
                # é¡¯ç¤ºè¨Šè™Ÿå¼·åº¦
                rssi_text = f"[{dev.rssi}dBm]" if dev.rssi else "[?]"
                
                # æ¨™è¨˜å¯èƒ½çš„ EMG ç›¸é—œè£ç½®
                name = dev.name or "(unknown)"
                if any(keyword in name.upper() for keyword in ["EMG", "WL", "SENSOR", "MUSCLE"]):
                    name = f"â­ {name}"
                
                label = f"{name} {rssi_text} ({dev.address})"
                index = self._device_combo.count()
                self._device_combo.addItem(label, userData=dev.address)
                self._device_items[index] = DeviceEntry(label, dev.address)
            
            self._log(f"Found {len(devices)} device(s). æç¤ºï¼šæ‹”æ‰ USB å†æƒæä¸€æ¬¡ï¼Œæ¯”è¼ƒå“ªå€‹è£ç½®æ¶ˆå¤±äº†")
        except Exception as exc:
            self._log(f"Scan failed: {exc}")
            # æƒæå¤±æ•—ï¼Œè—ç‰™æ¥æ”¶å™¨è¨­ç‚ºç´…è‰²
            self._bt_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæå¤±æ•—")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
        finally:
            self._set_controls_enabled(scanning=False)

    @asyncSlot()
    async def _on_connect_clicked(self) -> None:
        # å¾ USB åºåˆ—åŸ ä¸‹æ‹‰é¸å–®ç²å–é¸æ“‡çš„è£ç½®
        selected_port = self._usb_device_combo.currentText()
        
        if not selected_port or selected_port.startswith("æ­£åœ¨") or selected_port.startswith("å°šæœª"):
            self._log("è«‹å…ˆæƒæä¸¦é¸æ“‡ä¸€å€‹åºåˆ—åŸ ")
            return
            
        # è§£æåºåˆ—åŸ è·¯å¾‘ï¼ˆæ ¼å¼ï¼š/dev/xxx - æè¿° æˆ– /dev/xxx (æè¿°)ï¼‰
        if " - " in selected_port:
            port_path = selected_port.split(" - ")[0].strip()
        elif " (" in selected_port:
            port_path = selected_port.split(" (")[0].strip()
        else:
            port_path = selected_port.strip()
        
        if not port_path.startswith('/dev/'):
            self._log(f"ç„¡æ•ˆçš„åºåˆ—åŸ ï¼š{port_path}")
            return
        
        entry = DeviceEntry(label=selected_port, address=port_path)
        
        # ä½¿ç”¨åºåˆ—åŸ ç®¡ç†å™¨
        manager = self._serial_manager
        self._is_simulation = False
        
        # USB æ¥æ”¶å™¨é€£æ¥ä¸­ï¼ˆé»ƒè‰²ï¼‰
        self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
        self._usb_status_text.setText("é€£æ¥ä¸­...")
        self._usb_status_text.setStyleSheet("color: #FFCC00;")
            
        await self._disconnect_active()
        self._active_manager = manager
        try:
            await manager.connect(entry.address)
        except Exception as exc:
            self._log(f"é€£æ¥å¤±æ•—: {exc}")
            self._active_manager = None
            # é€£æ¥å¤±æ•—ï¼šç´…è‰²
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("é€£æ¥å¤±æ•—")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            return
            
        self._connected = True
        self._buffer.clear()
        self._packet_count = 0
        import time
        self._last_packet_time = time.time()
        self._set_controls_enabled()
        
        # é€£æ¥æˆåŠŸï¼šç¶ è‰²
        self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
        self._usb_status_text.setText("å·²é€£æ¥")
        self._usb_status_text.setStyleSheet("color: #4CD964; font-weight: bold;")
        self._log(f"å·²é€£æ¥åˆ° {entry.label}")

    @asyncSlot()
    async def _on_disconnect_clicked(self) -> None:
        await self._disconnect_active()

    async def _disconnect_active(self) -> None:
        if not self._active_manager:
            return
        try:
            await self._active_manager.disconnect()
        except Exception as exc:
            self._log(f"Error while disconnecting: {exc}")
        self._active_manager = None
        self._connected = False
        self._packet_count = 0
        self._signal_strength = 0.0
        self._set_controls_enabled()
        self._status_label.setText("Status: Disconnected")
        
        # é‡ç½®æ‰€æœ‰æŒ‡ç¤ºå™¨ç‚ºç°è‰²
        self._usb_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._usb_status_text.setText("æœªæª¢æ¸¬")
        self._usb_status_text.setStyleSheet("color: gray;")
        self._signal_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._strength_label.setText("ğŸ’ª è¨Šè™Ÿå¼·åº¦: --")
