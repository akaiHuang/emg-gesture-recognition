"""Qt main window for the EMG monitor application."""

from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, Optional

import numpy as np
import pyqtgraph as pg
from PyQt6 import QtCore, QtWidgets
from qasync import asyncSlot

from .. import config
from ..buffers import EmgRingBuffer
from ..data_parser import EmgSample, ImuSample
from ..device_manager import DeviceManager
from ..sim_device import SimulatedDeviceManager


class PacketBridge(QtCore.QObject):
    """Bridge raw callbacks to Qt signals."""

    emg_received = QtCore.pyqtSignal(object)
    imu_received = QtCore.pyqtSignal(object)
    status_changed = QtCore.pyqtSignal(str)

    def emit_packet(self, packet: EmgSample | ImuSample) -> None:
        if isinstance(packet, EmgSample):
            self.emg_received.emit(packet)
        else:
            self.imu_received.emit(packet)

    def emit_status(self, message: str) -> None:
        self.status_changed.emit(message)


@dataclass
class DeviceEntry:
    label: str
    address: str


class MainWindow(QtWidgets.QMainWindow):
    """Top-level application window."""

    def __init__(self) -> None:
        super().__init__()
        self.setWindowTitle("WL-EMG Monitor")
        self._bridge = PacketBridge()
        self._bridge.emg_received.connect(self._handle_emg_sample)
        self._bridge.imu_received.connect(self._handle_imu_sample)
        self._bridge.status_changed.connect(self._handle_status_update)

        self._real_manager = DeviceManager(
            notification_uuid=config.DEFAULT_NOTIFICATION_UUID,
            on_packet=self._bridge.emit_packet,
            on_status=self._bridge.emit_status,
        )
        self._sim_manager = SimulatedDeviceManager(
            on_packet=self._bridge.emit_packet,
            on_status=self._bridge.emit_status,
        )
        self._active_manager: Optional[
            DeviceManager | SimulatedDeviceManager
        ] = None

        self._device_items: Dict[int, DeviceEntry] = {}
        self._connected = False
        self._buffer = EmgRingBuffer(
            channels=config.EMG_CHANNELS,
            capacity=config.SAMPLE_RATE_HZ * config.BUFFER_SECONDS,
        )
        self._display_offsets = [
            idx * 400.0 for idx in range(config.EMG_CHANNELS)
        ]
        
        # ç‹€æ…‹è¿½è¹¤
        self._last_packet_time = 0.0
        self._packet_count = 0
        self._signal_strength = 0.0
        self._is_simulation = False

        self._build_ui()
        self._plot_timer = QtCore.QTimer(self)
        self._plot_timer.setInterval(33)  # ~30 FPS
        self._plot_timer.timeout.connect(self._refresh_plot)
        self._plot_timer.start()

        self._log("Ready.")

    # ------------------------------------------------------------------ UI --
    def _build_ui(self) -> None:
        central = QtWidgets.QWidget(self)
        layout = QtWidgets.QVBoxLayout(central)
        
        # ç¬¬ä¸€æ’æ§åˆ¶æŒ‰éˆ•ï¼šUSB æª¢æ¸¬
        usb_layout = QtWidgets.QHBoxLayout()
        
        self._usb_scan_button = QtWidgets.QPushButton("ğŸ” Search USB Device")
        self._usb_scan_button.clicked.connect(self._on_usb_scan_clicked)
        self._usb_scan_button.setStyleSheet("font-weight: bold; background-color: #4CD964; color: white;")
        usb_layout.addWidget(self._usb_scan_button)
        
        # USB è£ç½®åˆ—è¡¨ä¸‹æ‹‰é¸å–®
        self._usb_device_combo = QtWidgets.QComboBox()
        self._usb_device_combo.setMinimumWidth(400)
        self._usb_device_combo.addItem("å°šæœªæƒæ - è«‹é»æ“Š Search USB Device")
        usb_layout.addWidget(self._usb_device_combo, stretch=1)
        
        self._usb_info_label = QtWidgets.QLabel("é»æ“ŠæŒ‰éˆ•æª¢æ¸¬æ‰€æœ‰è—ç‰™è£ç½®")
        self._usb_info_label.setStyleSheet("color: gray; font-style: italic;")
        usb_layout.addWidget(self._usb_info_label)
        usb_layout.addStretch()
        
        layout.addLayout(usb_layout)
        
        # ç¬¬äºŒæ’æ§åˆ¶æŒ‰éˆ•ï¼šè—ç‰™è£ç½®æƒæèˆ‡é€£æ¥
        controls_layout = QtWidgets.QHBoxLayout()

        self._scan_button = QtWidgets.QPushButton("Search Bluetooth Devices")
        self._scan_button.clicked.connect(self._on_scan_clicked)
        controls_layout.addWidget(self._scan_button)

        self._device_combo = QtWidgets.QComboBox()
        controls_layout.addWidget(self._device_combo)
        self._device_combo.addItem("Simulation", userData="SIM")
        self._device_items = {0: DeviceEntry("Simulation", "SIM")}

        self._connect_button = QtWidgets.QPushButton("Connect")
        self._connect_button.clicked.connect(self._on_connect_clicked)
        controls_layout.addWidget(self._connect_button)

        self._disconnect_button = QtWidgets.QPushButton("Disconnect")
        self._disconnect_button.clicked.connect(self._on_disconnect_clicked)
        self._disconnect_button.setEnabled(False)
        controls_layout.addWidget(self._disconnect_button)

        layout.addLayout(controls_layout)

        # ç‹€æ…‹æŒ‡ç¤ºå™¨å€åŸŸ
        status_group = QtWidgets.QGroupBox("ç³»çµ±ç‹€æ…‹")
        status_layout = QtWidgets.QHBoxLayout()
        
        # 1. USB æ¥æ”¶å™¨ç‹€æ…‹ï¼ˆæ–°å¢ï¼‰
        self._usb_status_label = QtWidgets.QLabel("ğŸ”Œ USB æ¥æ”¶å™¨")
        self._usb_status_indicator = QtWidgets.QLabel("â—")
        self._usb_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._usb_status_text = QtWidgets.QLabel("æœªæª¢æ¸¬")
        self._usb_status_text.setStyleSheet("color: gray;")
        status_layout.addWidget(self._usb_status_label)
        status_layout.addWidget(self._usb_status_indicator)
        status_layout.addWidget(self._usb_status_text)
        status_layout.addSpacing(20)
        
        # 2. è—ç‰™åŠŸèƒ½ç‹€æ…‹
        self._bt_status_label = QtWidgets.QLabel("ï¿½ è—ç‰™åŠŸèƒ½")
        self._bt_status_indicator = QtWidgets.QLabel("â—")
        self._bt_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        status_layout.addWidget(self._bt_status_label)
        status_layout.addWidget(self._bt_status_indicator)
        status_layout.addSpacing(20)
        
        # 3. è£ç½®é€£æ¥ç‹€æ…‹
        self._device_status_label = QtWidgets.QLabel("ğŸ“± EMG è£ç½®")
        self._device_status_indicator = QtWidgets.QLabel("â—")
        self._device_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        status_layout.addWidget(self._device_status_label)
        status_layout.addWidget(self._device_status_indicator)
        status_layout.addSpacing(20)
        
        # 4. è¨Šè™Ÿæ¥æ”¶ç‹€æ…‹
        self._signal_status_label = QtWidgets.QLabel("ï¿½ è¨Šè™Ÿæ¥æ”¶")
        self._signal_status_indicator = QtWidgets.QLabel("â—")
        self._signal_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        status_layout.addWidget(self._signal_status_label)
        status_layout.addWidget(self._signal_status_indicator)
        status_layout.addSpacing(20)
        
        # 5. è¨Šè™Ÿå¼·åº¦
        self._strength_label = QtWidgets.QLabel("ğŸ’ª è¨Šè™Ÿå¼·åº¦: --")
        status_layout.addWidget(self._strength_label)
        status_layout.addStretch()
        
        status_group.setLayout(status_layout)
        layout.addWidget(status_group)

        self._status_label = QtWidgets.QLabel("Status: Disconnected")
        layout.addWidget(self._status_label)

        self._plot_widget = pg.PlotWidget()
        self._plot_widget.setBackground("k")
        self._plot_widget.showGrid(x=True, y=True, alpha=0.3)
        self._plot_widget.setLabel("left", "EMG (uV)")
        self._plot_widget.setLabel("bottom", "Time (s)")
        self._plot_widget.setLimits(xMin=-config.BUFFER_SECONDS, xMax=0)
        layout.addWidget(self._plot_widget, stretch=1)

        colors = [
            "#FF3B30",
            "#FF9500",
            "#FFCC00",
            "#4CD964",
            "#5AC8FA",
            "#007AFF",
            "#5856D6",
            "#FF2D55",
        ]
        self._curves = [
            self._plot_widget.plot(
                pen=pg.mkPen(color=colors[idx % len(colors)], width=1.5)
            )
            for idx in range(config.EMG_CHANNELS)
        ]

        self._log_view = QtWidgets.QPlainTextEdit()
        self._log_view.setReadOnly(True)
        self._log_view.setMaximumHeight(120)
        layout.addWidget(self._log_view)

        central.setLayout(layout)
        self.setCentralWidget(central)
        self.resize(1024, 768)

    # -------------------------------------------------------------- Helpers --
    def _current_device(self) -> DeviceEntry:
        idx = self._device_combo.currentIndex()
        entry = self._device_items.get(idx)
        if entry is None:
            raise ValueError("No device selected")
        return entry

    def _set_controls_enabled(self, scanning: bool = False) -> None:
        self._scan_button.setEnabled(not self._connected and not scanning)
        self._connect_button.setEnabled(not self._connected and not scanning)
        self._disconnect_button.setEnabled(self._connected)
        self._device_combo.setEnabled(not self._connected and not scanning)
        self._usb_scan_button.setEnabled(not scanning)

    def _log(self, message: str) -> None:
        self._log_view.appendPlainText(message)

    # ------------------------------------------------------------ Callbacks --
    def _handle_emg_sample(self, sample: EmgSample) -> None:
        try:
            self._buffer.append(sample.channels_uv)
            # æ›´æ–°è¨Šè™Ÿæ¥æ”¶ç‹€æ…‹
            import time
            self._last_packet_time = time.time()
            self._packet_count += 1
            
            # è¨ˆç®—è¨Šè™Ÿå¼·åº¦ï¼ˆä½¿ç”¨æ‰€æœ‰é€šé“çš„ RMSï¼‰
            rms_values = [np.sqrt(np.mean(np.array(ch)**2)) for ch in sample.channels_uv]
            self._signal_strength = np.mean(rms_values)
            
            # æ›´æ–°è¨Šè™Ÿæ¥æ”¶æŒ‡ç¤ºå™¨ç‚ºç¶ è‰²
            self._signal_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
            
        except ValueError as exc:
            self._log(f"EMG buffer error: {exc}")

    def _handle_imu_sample(self, sample: ImuSample) -> None:
        gyro = ", ".join(f"{axis:.2f}" for axis in sample.gyro_rads)
        accel = ", ".join(f"{axis:.2f}" for axis in sample.accel_mss)
        self._status_label.setText(
            f"Status: Connected | Gyro {gyro} rad/s | Accel {accel} m/s^2"
        )

    def _handle_status_update(self, message: str) -> None:
        self._log(message)
        prefix = "Status: Connected | " if self._connected else "Status: "
        self._status_label.setText(f"{prefix}{message}")

    def _refresh_plot(self) -> None:
        import time
        
        # æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        current_time = time.time()
        
        # æª¢æŸ¥è¨Šè™Ÿæ˜¯å¦é‚„åœ¨æ¥æ”¶ï¼ˆè¶…é1ç§’æ²’æ”¶åˆ°å°±é¡¯ç¤ºç´…è‰²ï¼‰
        if self._connected and (current_time - self._last_packet_time) > 1.0:
            self._signal_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._strength_label.setText("ğŸ’ª è¨Šè™Ÿå¼·åº¦: ç„¡è¨Šè™Ÿ")
        elif self._connected:
            # æ›´æ–°è¨Šè™Ÿå¼·åº¦é¡¯ç¤º
            if self._signal_strength > 100:
                strength_text = "å¼· ğŸŸ¢"
            elif self._signal_strength > 30:
                strength_text = "ä¸­ ğŸŸ¡"
            elif self._signal_strength > 0:
                strength_text = "å¼± ğŸŸ "
            else:
                strength_text = "ç„¡ âšª"
            self._strength_label.setText(f"ğŸ’ª è¨Šè™Ÿå¼·åº¦: {self._signal_strength:.1f} Î¼V ({strength_text})")
        
        data = self._buffer.snapshot()
        if data.size == 0:
            for curve in self._curves:
                curve.clear()
            return
        points = data.shape[1]
        duration = points / config.SAMPLE_RATE_HZ
        x = np.linspace(-duration, 0, points)
        for idx, curve in enumerate(self._curves):
            channel_data = data[idx] + self._display_offsets[idx]
            curve.setData(x, channel_data)
        self._plot_widget.setYRange(
            -200, self._display_offsets[-1] + 600, padding=0.01
        )

    # ---------------------------------------------------------- UI actions --
    @asyncSlot()
    async def _on_usb_scan_clicked(self) -> None:
        """æƒæ USB è£ç½®"""
        self._set_controls_enabled(scanning=True)
        self._log("ğŸ” æƒæ USB è£ç½®...")
        self._usb_info_label.setText("æƒæä¸­...")
        self._usb_info_label.setStyleSheet("color: #FFCC00; font-style: italic;")
        
        # USB ç‹€æ…‹è¨­ç‚ºæª¢æ¸¬ä¸­ï¼ˆé»ƒè‰²ï¼‰
        self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
        self._usb_status_text.setText("æƒæä¸­...")
        self._usb_status_text.setStyleSheet("color: #FFCC00;")
        
        # æ¸…ç©ºåˆ—è¡¨
        self._usb_device_combo.clear()
        
        try:
            # ä½¿ç”¨æ›´ç°¡å–®çš„ ioreg å‘½ä»¤æƒæ USB è£ç½®
            import subprocess
            
            result = subprocess.run(
                ["ioreg", "-p", "IOUSB", "-l", "-w", "0"],
                capture_output=True,
                text=True,
                timeout=10
            )
            
            if result.returncode != 0:
                raise Exception("ç„¡æ³•åŸ·è¡Œ ioreg")
            
            # è§£æè¼¸å‡º
            devices = self._parse_ioreg_usb(result.stdout)
            data = json.loads(result.stdout)
            devices = self._parse_usb_devices(data)
            
            if devices:
                # æ›´æ–°ç‹€æ…‹
                self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
                self._usb_status_text.setText(f"æ‰¾åˆ° {len(devices)} å€‹")
                self._usb_status_text.setStyleSheet("color: #4CD964; font-weight: bold;")
                
                # çµ±è¨ˆè³‡è¨Š
                bluetooth_count = sum(1 for dev in devices if "bluetooth" in dev["name"].lower() or "bt" in dev["name"].lower())
                
                info = f"âœ“ æƒæå®Œæˆï¼šå…±æ‰¾åˆ° {len(devices)} å€‹ USB è£ç½®\n"
                if bluetooth_count > 0:
                    info += f"  - è—ç‰™ç›¸é—œè£ç½®: {bluetooth_count} å€‹ ğŸ“¡\n"
                info += f"\næç¤ºï¼šæ‹”æ‰ USB è—ç‰™æ¥æ”¶å™¨å†æƒæä¸€æ¬¡ï¼Œæ¯”è¼ƒå“ªå€‹è£ç½®æ¶ˆå¤±äº†"
                self._log(info)
                
                self._usb_info_label.setText(f"âœ“ æ‰¾åˆ° {len(devices)} å€‹ USB è£ç½®")
                self._usb_info_label.setStyleSheet("color: #4CD964; font-weight: bold;")
                
                # æ·»åŠ è£ç½®åˆ°ä¸‹æ‹‰é¸å–®
                for dev in devices:
                    name = dev["name"]
                    vendor = dev.get("vendor", "")
                    product_id = dev.get("product_id", "")
                    vendor_id = dev.get("vendor_id", "")
                    
                    # æ¨™è¨˜è—ç‰™ç›¸é—œè£ç½®
                    if "bluetooth" in name.lower() or "bt" in name.lower():
                        name = f"ğŸ“¡ {name}"
                    
                    label = f"{name}"
                    if vendor:
                        label += f" - {vendor}"
                    if product_id or vendor_id:
                        label += f" [{vendor_id}:{product_id}]"
                    
                    self._usb_device_combo.addItem(label)
                
                # è¨˜éŒ„è©³ç´°åˆ—è¡¨
                self._log("\næƒæåˆ°çš„ USB è£ç½®åˆ—è¡¨ï¼š")
                for i, dev in enumerate(devices, 1):
                    name = dev["name"]
                    vendor = dev.get("vendor", "Unknown")
                    marker = "ğŸ“¡" if "bluetooth" in name.lower() or "bt" in name.lower() else "  "
                    self._log(f"{marker} {i}. {name} ({vendor})")
                
            else:
                # æ²’æ‰¾åˆ°ä»»ä½•è£ç½®
                self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
                self._usb_status_text.setText("ç„¡ USB è£ç½®")
                self._usb_status_text.setStyleSheet("color: #FFCC00; font-weight: bold;")
                
                self._usb_device_combo.addItem("æœªæ‰¾åˆ°ä»»ä½• USB è£ç½®ï¼ˆå¯èƒ½åªæœ‰å…§å»ºè£ç½®ï¼‰")
                self._usb_info_label.setText("æœªæ‰¾åˆ°å¤–æ¥ USB è£ç½®")
                self._usb_info_label.setStyleSheet("color: #FFCC00; font-style: italic;")
                self._log("æœªæ‰¾åˆ°å¤–æ¥ USB è£ç½®")
                    
        except subprocess.TimeoutExpired:
            self._log("USB æƒæé€¾æ™‚")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæé€¾æ™‚")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            self._usb_device_combo.addItem("æƒæé€¾æ™‚")
            self._usb_info_label.setText("âœ— æƒæé€¾æ™‚")
            self._usb_info_label.setStyleSheet("color: #FF3B30; font-style: italic;")
        except Exception as exc:
            self._log(f"USB æƒæå¤±æ•—: {exc}")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæå¤±æ•—")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            self._usb_device_combo.addItem("æƒæå¤±æ•—")
            self._usb_info_label.setText("âœ— æƒæå¤±æ•—")
            self._usb_info_label.setStyleSheet("color: #FF3B30; font-style: italic;")
        finally:
            self._set_controls_enabled(scanning=False)
    
    def _parse_ioreg_usb(self, output: str) -> list:
        """è§£æ ioreg USB è£ç½®è³‡æ–™"""
        devices = []
        lines = output.split('\n')
        
        current_device = None
        for line in lines:
            # å°‹æ‰¾è£ç½®åç¨±
            if '"USB Product Name" = ' in line:
                name = line.split('"USB Product Name" = "')[1].split('"')[0]
                current_device = {"name": name, "vendor": "", "product_id": "", "vendor_id": ""}
            elif '"USB Vendor Name" = ' in line and current_device:
                vendor = line.split('"USB Vendor Name" = "')[1].split('"')[0]
                current_device["vendor"] = vendor
            elif '"idProduct" = ' in line and current_device:
                product_id = line.split('"idProduct" = ')[1].split('\n')[0].strip()
                current_device["product_id"] = product_id
            elif '"idVendor" = ' in line and current_device:
                vendor_id = line.split('"idVendor" = ')[1].split('\n')[0].strip()
                current_device["vendor_id"] = vendor_id
                # ç•¶æ‰¾åˆ° vendor_id æ™‚ï¼Œèªç‚ºä¸€å€‹è£ç½®è³‡è¨Šæ”¶é›†å®Œç•¢
                if current_device["name"]:
                    devices.append(current_device)
                current_device = None
        
        return devices

    @asyncSlot()
                # æ›´æ–°ç‹€æ…‹
                self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
                self._usb_status_text.setText(f"æ‰¾åˆ° {len(devices)} å€‹")
                self._usb_status_text.setStyleSheet("color: #4CD964; font-weight: bold;")
                
                # çµ±è¨ˆè³‡è¨Š
                bluetooth_count = sum(1 for dev in devices if "bluetooth" in dev["name"].lower() or "bt" in dev["name"].lower())
                
                info = f"âœ“ æƒæå®Œæˆï¼šå…±æ‰¾åˆ° {len(devices)} å€‹ USB è£ç½®\n"
                if bluetooth_count > 0:
                    info += f"  - è—ç‰™ç›¸é—œè£ç½®: {bluetooth_count} å€‹ ğŸ“¡\n"
                info += f"\næç¤ºï¼šæ‹”æ‰ USB è—ç‰™æ¥æ”¶å™¨å†æƒæä¸€æ¬¡ï¼Œæ¯”è¼ƒå“ªå€‹è£ç½®æ¶ˆå¤±äº†"
                self._log(info)
                
                self._usb_info_label.setText(f"âœ“ æ‰¾åˆ° {len(devices)} å€‹ USB è£ç½®")
                self._usb_info_label.setStyleSheet("color: #4CD964; font-weight: bold;")
                
                # æ·»åŠ è£ç½®åˆ°ä¸‹æ‹‰é¸å–®
                for dev in devices:
                    name = dev["name"]
                    vendor = dev.get("vendor", "")
                    product_id = dev.get("product_id", "")
                    vendor_id = dev.get("vendor_id", "")
                    
                    # æ¨™è¨˜è—ç‰™ç›¸é—œè£ç½®
                    if "bluetooth" in name.lower() or "bt" in name.lower():
                        name = f"ğŸ“¡ {name}"
                    
                    label = f"{name}"
                    if vendor:
                        label += f" - {vendor}"
                    if product_id and vendor_id:
                        label += f" [{vendor_id}:{product_id}]"
                    
                    self._usb_device_combo.addItem(label)
                
                # è¨˜éŒ„è©³ç´°åˆ—è¡¨
                self._log("\næƒæåˆ°çš„ USB è£ç½®åˆ—è¡¨ï¼š")
                for i, dev in enumerate(devices, 1):
                    name = dev["name"]
                    vendor = dev.get("vendor", "Unknown")
                    marker = "ğŸ“¡" if "bluetooth" in name.lower() or "bt" in name.lower() else "  "
                    self._log(f"{marker} {i}. {name} ({vendor})")
                
            else:
                # æ²’æ‰¾åˆ°ä»»ä½•è£ç½®
                self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
                self._usb_status_text.setText("ç„¡ USB è£ç½®")
                self._usb_status_text.setStyleSheet("color: #FFCC00; font-weight: bold;")
                
                self._usb_device_combo.addItem("æœªæ‰¾åˆ°ä»»ä½• USB è£ç½®ï¼ˆå¯èƒ½åªæœ‰å…§å»ºè£ç½®ï¼‰")
                self._usb_info_label.setText("æœªæ‰¾åˆ°å¤–æ¥ USB è£ç½®")
                self._usb_info_label.setStyleSheet("color: #FFCC00; font-style: italic;")
                self._log("æœªæ‰¾åˆ°å¤–æ¥ USB è£ç½®")
                    
        except subprocess.TimeoutExpired:
            self._log("USB æƒæé€¾æ™‚")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæé€¾æ™‚")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            self._usb_device_combo.addItem("æƒæé€¾æ™‚")
            self._usb_info_label.setText("âœ— æƒæé€¾æ™‚")
            self._usb_info_label.setStyleSheet("color: #FF3B30; font-style: italic;")
        except Exception as exc:
            self._log(f"USB æƒæå¤±æ•—: {exc}")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæå¤±æ•—")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
            self._usb_device_combo.addItem("æƒæå¤±æ•—")
            self._usb_info_label.setText("âœ— æƒæå¤±æ•—")
            self._usb_info_label.setStyleSheet("color: #FF3B30; font-style: italic;")
        finally:
            self._set_controls_enabled(scanning=False)
    
    def _parse_usb_devices(self, data: dict) -> list:
        """è§£æ USB è£ç½®è³‡æ–™"""
        devices = []
        
        def extract_devices(item):
            if isinstance(item, dict):
                # æª¢æŸ¥æ˜¯å¦æ˜¯ USB è£ç½®
                if "_name" in item:
                    device_info = {
                        "name": item.get("_name", "Unknown"),
                        "vendor": item.get("manufacturer", ""),
                        "product_id": item.get("product_id", ""),
                        "vendor_id": item.get("vendor_id", ""),
                    }
                    # æ’é™¤ç³»çµ±å…§å»ºè£ç½®ï¼ˆé€šå¸¸æ²’æœ‰ product_idï¼‰
                    if device_info["name"] != "USB" and device_info["name"] != "USB Bus":
                        devices.append(device_info)
                
                # éè¿´è™•ç† _items
                if "_items" in item:
                    for sub_item in item["_items"]:
                        extract_devices(sub_item)
                        
            elif isinstance(item, list):
                for sub_item in item:
                    extract_devices(sub_item)
        
        # å¾æ ¹é–‹å§‹è§£æ
        if "SPUSBDataType" in data:
            for bus in data["SPUSBDataType"]:
                extract_devices(bus)
        
        return devices

    @asyncSlot()
    async def _on_scan_clicked(self) -> None:
        self._set_controls_enabled(scanning=True)
        self._log("Starting Bluetooth scan...")
        
        # å˜—è©¦æƒææ™‚ï¼Œè—ç‰™æ¥æ”¶å™¨ç‹€æ…‹è¨­ç‚ºé»ƒè‰²ï¼ˆæª¢æ¸¬ä¸­ï¼‰
        self._bt_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
        
        self._device_combo.clear()
        self._device_combo.addItem("Simulation", userData="SIM")
        self._device_items = {0: DeviceEntry("Simulation", "SIM")}
        try:
            devices = await self._real_manager.scan(
                timeout=config.DEFAULT_SCAN_TIMEOUT
            )
            # æƒææˆåŠŸï¼Œè—ç‰™æ¥æ”¶å™¨è¨­ç‚ºç¶ è‰²
            self._bt_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
            
            # æª¢æŸ¥æ˜¯å¦æœ‰ WL è£ç½®ï¼ˆè¡¨ç¤º USB æ¥æ”¶å™¨å·²é€£æ¥ï¼‰
            has_wl_device = any("WL" in (dev.name or "").upper() or 
                               "EEG" in (dev.name or "").upper() 
                               for dev in devices)
            
            if has_wl_device:
                self._usb_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
                self._usb_status_text.setText("å·²åµæ¸¬åˆ° WL è£ç½®")
                self._usb_status_text.setStyleSheet("color: #4CD964; font-weight: bold;")
            else:
                self._usb_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
                self._usb_status_text.setText("æœªæ‰¾åˆ° WL è£ç½®")
                self._usb_status_text.setStyleSheet("color: #FFCC00;")
            
            # æŒ‰ RSSI æ’åºï¼ˆè¨Šè™Ÿå¼·åº¦ç”±å¼·åˆ°å¼±ï¼‰
            devices_sorted = sorted(devices, key=lambda d: d.rssi or -999, reverse=True)
            
            for dev in devices_sorted:
                # é¡¯ç¤ºè¨Šè™Ÿå¼·åº¦
                rssi_text = f"[{dev.rssi}dBm]" if dev.rssi else "[?]"
                
                # æ¨™è¨˜å¯èƒ½çš„ EMG ç›¸é—œè£ç½®
                name = dev.name or "(unknown)"
                if any(keyword in name.upper() for keyword in ["EMG", "WL", "SENSOR", "MUSCLE"]):
                    name = f"â­ {name}"
                
                label = f"{name} {rssi_text} ({dev.address})"
                index = self._device_combo.count()
                self._device_combo.addItem(label, userData=dev.address)
                self._device_items[index] = DeviceEntry(label, dev.address)
            
            self._log(f"Found {len(devices)} device(s). æç¤ºï¼šæ‹”æ‰ USB å†æƒæä¸€æ¬¡ï¼Œæ¯”è¼ƒå“ªå€‹è£ç½®æ¶ˆå¤±äº†")
        except Exception as exc:
            self._log(f"Scan failed: {exc}")
            # æƒæå¤±æ•—ï¼Œè—ç‰™æ¥æ”¶å™¨è¨­ç‚ºç´…è‰²
            self._bt_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            self._usb_status_text.setText("æƒæå¤±æ•—")
            self._usb_status_text.setStyleSheet("color: #FF3B30;")
        finally:
            self._set_controls_enabled(scanning=False)

    @asyncSlot()
    async def _on_connect_clicked(self) -> None:
        entry = self._current_device()
        if entry.address == "SIM":
            manager = self._sim_manager
            self._is_simulation = True
            # æ¨¡æ“¬æ¨¡å¼ï¼šè—ç‰™ç‚ºç°è‰²ï¼ˆä¸ä½¿ç”¨ï¼‰ï¼Œè£ç½®ç‚ºè—è‰²ï¼ˆæ¨¡æ“¬ï¼‰
            self._bt_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
            self._device_status_indicator.setStyleSheet("color: #007AFF; font-size: 20px;")
        else:
            manager = self._real_manager
            self._is_simulation = False
            # çœŸå¯¦æ¨¡å¼ï¼šè£ç½®é€£æ¥ä¸­ï¼ˆé»ƒè‰²ï¼‰
            self._device_status_indicator.setStyleSheet("color: #FFCC00; font-size: 20px;")
            
        await self._disconnect_active()
        self._active_manager = manager
        try:
            await manager.connect(entry.address)
        except Exception as exc:
            self._log(f"Connection failed: {exc}")
            self._active_manager = None
            # é€£æ¥å¤±æ•—ï¼šè£ç½®ç‚ºç´…è‰²
            self._device_status_indicator.setStyleSheet("color: #FF3B30; font-size: 20px;")
            return
        self._connected = True
        self._buffer.clear()
        self._packet_count = 0
        import time
        self._last_packet_time = time.time()
        self._set_controls_enabled()
        
        # é€£æ¥æˆåŠŸï¼šè£ç½®ç‚ºç¶ è‰²
        self._device_status_indicator.setStyleSheet("color: #4CD964; font-size: 20px;")
        self._log(f"Connected to {entry.label}")

    @asyncSlot()
    async def _on_disconnect_clicked(self) -> None:
        await self._disconnect_active()

    async def _disconnect_active(self) -> None:
        if not self._active_manager:
            return
        try:
            await self._active_manager.disconnect()
        except Exception as exc:
            self._log(f"Error while disconnecting: {exc}")
        self._active_manager = None
        self._connected = False
        self._packet_count = 0
        self._signal_strength = 0.0
        self._set_controls_enabled()
        self._status_label.setText("Status: Disconnected")
        
        # é‡ç½®æ‰€æœ‰æŒ‡ç¤ºå™¨ç‚ºç°è‰²
        self._bt_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._device_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._signal_status_indicator.setStyleSheet("color: gray; font-size: 20px;")
        self._strength_label.setText("ğŸ’ª è¨Šè™Ÿå¼·åº¦: --")
